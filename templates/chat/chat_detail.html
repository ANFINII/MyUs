{% extends 'base2.html' %}
{% block title %}<title>MyUsチャット</title>{% endblock title %}

{% load static %}
{% load humanize %}

{% block customcss %}
<link rel="stylesheet" type="text/css" href="{% static 'css/index.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'css/chat.css' %}">
{% endblock customcss %}

{% block content %}
<main class="main_contents">
    <article class="article_detail_chat">
    {% if object.publish %}
        <div class="chat_section">
            <div class="chat_section_header">
                <h1 title="{{ object.title }}">{{ object.title }}</h1>

                <div class="article_detail_aria_2">
                    <div class="view_good_inline">
                        <i class="bi bi-caret-right-square" title="閲覧数"></i>
                        <span>{{ object.read|intcomma }}</span>
                    </div>

                    <div class="view_good_inline">
                        <i class="bi bi-person" title="参加数"></i>
                        <span id="user_count">{{ object.user_count|intcomma }}</span>
                    </div>

                    <div class="view_good_inline">
                        <i class="bi bi-chat-dots" title="投稿数"></i>
                        <span id="comment_count">{{ object.comment_count|intcomma }}</span>
                    </div>

                    {% if user.is_authenticated %}
                        <form method="POST" action="{% url 'myus:like_form' %}" class="view_good_inline char_like" path="{{ request.path }}">{% csrf_token %}
                            {% if liked %}
                            <button type="submit" name="chatmodel_id" value="{{ object.id }}" class="like_form like_fill">
                                <i class="bi bi-hand-thumbs-up-fill like_color" title="いいね"></i>
                            </button>
                            {% else %}
                            <button type="submit" name="chatmodel_id" value="{{ object.id }}" class="like_form like_no">
                                <i class="bi bi-hand-thumbs-up like_color" title="いいね"></i>
                            </button>
                            {% endif %}
                            <span class="like_count">{{ object.total_like|intcomma }}</span>
                        </form>
                    {% else %}
                    <div class="view_good_inline">
                        <i class="bi bi-hand-thumbs-up" title="いいね"></i>
                        <span>{{ object.total_like|intcomma }}</span>
                    </div>
                    {% endif %}
                    <time>期間 {{ object.period|date:'Y/m/d' }}</time>
                </div>
                
                <div class="chat_section_content">
                    <input type="checkbox" id="chat_content_check_id" class="chat_content_check">

                    <label for="chat_content_check_id" class="chat_content_label" title="内容">
                        <i class="bi bi-file-text" title="内容"></i>
                    </label>

                    <div class="chat_content">
                        <div class="chat_content_list">
                            <a href="{% url 'myus:userpage' object.author.nickname %}">
                                <img src="{{ object.author.user_image.url }}" title="{{ object.author.nickname }}" class="profile_image_comment">
                            </a>
                            <div class="chat_content_list_1">
                                <p>{{ object.author.nickname }}</p>
                                <time>{{ object.created|date:'Y/m/d H:i' }}</time>
                            </div>
                            <div class="chat_content_list_2">登録者数
                                <span class="follower_count">{{ object.author.follower_count }}</span>
                            </div>
                            <div class="chat_content_list_3">
                                {% if user.nickname == object.author.nickname %}
                                <button class="btn btn-secondary btn-sm" disabled>フォローする</button>
                                {% elif user.is_authenticated %}
                                <form method="POST" action="{% url 'myus:follow_create' object.author.nickname %}" class="follow_form">{% csrf_token %}
                                    {% if followed %}
                                    <button type="submit" name="following_id" value="{{ object.author.nickname }}" class="btn btn-danger btn-sm followchange">解除する</button>
                                    {% else %}
                                    <button type="submit" name="following_id" value="{{ object.author.nickname }}" class="btn btn-success btn-sm followchange">フォローする</button>
                                    {% endif %}
                                </form>
                                {% else %}
                                <button class="btn btn-secondary btn-sm" disabled>フォローする</button>
                                {% endif %}
                            </div>
                            <div class="chat_content_list_4">{{ object.content|linebreaksbr }}</div>
                        </div>
                    </div>
                </div>
                {% include 'parts/tag.html' %}
            </div>

            <input type="checkbox" id="chat_section_nav_check_id" class="chat_section_nav_check">
            <div class="chat_section_nav">
                <label for="chat_section_nav_check_id" class="chat_section_nav_label">
                    <i class="bi bi-arrow-left-right" title="開閉"></i>
                </label>
                <div  class="chat_section_nav_area">
                    {% for item in chat_list %}
                    <div class="chat_section_nav_list">
                        <a href="{% url 'myus:userpage' item.author.nickname %}">
                            <img src="{{ item.author.user_image.url }}" title="{{ item.author.nickname }}" class="profile_image_comment">
                        </a>
                        <a  href="{% url 'myus:chat_detail' item.pk %}">
                            <h3 title="{{ item.title }}">{{ item.title }}</h3>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <input type="checkbox" id="" class="comment_aria_check get-id-1">
            <div class="chat_section_main">
                <div class="chat_section_main_area">
                    {% for comment in comment_list %}
                    <form method="POST" action="{% url 'myus:chat_detail' object.pk comment.id %}" form-id="{{ comment.id }}" class="click_id">{% csrf_token %}
                        <label for="comment_aria_check_id_{{ comment.id }}" class="comment_aria_list">
                            <input type="hidden" name="from_id" value="{{ comment.id }}">
                            <a href="{% url 'myus:userpage' comment.author.nickname %}">
                                <img src="{{ comment.author.user_image.url }}" title="{{ comment.author.nickname }}" class="profile_image_comment">
                            </a>
                            <div class="comment_aria_list_1">
                                <p>{{ comment.author.nickname }}</p>
                                <time>{{ comment.created|date:'Y/m/d H:i' }}</time>
                            </div>
                            <div class="comment_aria_list_2">{{ comment.text|urlize|linebreaks }}</div>
                        </label>
                    </form>
                    {% endfor %}
                    <div id="comment_aria_add"></div>
                </div>

                <footer class="chat_footer_main" id="footer">
                    <form method="POST" action="{% url 'myus:chat_message' %}" id="comment_form" obj-id="{{ object.id }}">{% csrf_token %}
                        {% if is_period %}
                        <textarea name="text" rows="1" class="textarea_br" placeholder="チャット期間が過ぎています！" disabled="disabled"></textarea>
                        <div class="chat_frame chat_frame_color"></div>
                        <div class="comment_input_chat">
                            <button type="submit" class="btn btn-secondary btn-sm" title="送信" disabled>
                                <i class="bi bi-caret-right-fill" style="font-size: 1.2em;"></i>
                            </button>
                        </div>
                        {% elif user.is_authenticated %}
                        <textarea name="text" rows="1" class="textarea_br" placeholder="メッセージ入力" required></textarea>
                        <div class="chat_frame"></div>
                        <div class="comment_input_chat">
                            <button type="submit" class="btn btn-primary btn-sm" title="送信">
                                <i class="bi bi-caret-right-fill" style="font-size: 1.2em;"></i>
                            </button>
                        </div>
                        {% else %}
                        <textarea name="text" rows="1" class="textarea_br" placeholder="チャットするにはログインが必要です！" disabled="disabled"></textarea>
                        <div class="chat_frame chat_frame_color"></div>
                        <div class="comment_input_chat">
                            <button type="submit" class="btn btn-secondary btn-sm" title="送信" disabled>
                                <i class="bi bi-caret-right-fill" style="font-size: 1.2em;"></i>
                            </button>
                        </div>
                        {% endif %}
                    </form>
                </footer>
            </div>

            <div class="chat_section_header_cross">
                <h3>スレッド{{ form_id }}</h3>
                <label for="" class="chat_section_header_cross_check get-id-2">
                    <i class="bi bi-x" style="font-size: 1.7em;" title="閉じる"></i>
                </label>
            </div>
            
            <div class="chat_section_thread">
                {% for comment in comment_list %}
                    {% if comment.id == form_id %}
                    <label class="comment_aria_list">
                        <a href="{% url 'myus:userpage' comment.author.nickname %}">
                            <img src="{{ comment.author.user_image.url }}" title="{{ comment.author.nickname }}" class="profile_image_comment">
                        </a>
                        <div class="comment_aria_list_1">
                            <p>{{ comment.author.nickname }}</p>
                            <time>{{ comment.created|date:'Y/m/d H:i' }}</time>
                        </div>
                        <div class="comment_aria_list_2">{{ comment.text|urlize|linebreaks }}</div>
                    </label>
                    {% endif %}
                {% endfor %}

                {% for reply in reply_list %}
                    {% if reply.parent.id == form_id %}
                    <div class="comment_aria_list">
                        <a href="{% url 'myus:userpage' reply.author.nickname %}">
                            <img src="{{ reply.author.user_image.url }}" title="{{ reply.author.nickname }}" class="profile_image_comment">
                        </a>
                        <div class="comment_aria_list_1">
                            <p>{{ reply.author.nickname }}</p>
                            <time>{{ reply.created|date:'Y/m/d H:i' }}</time>
                        </div>
                        <div class="comment_aria_list_2">{{ reply.text|urlize|linebreaks }}</div>
                    </div>
                    {% endif %}
                {% endfor %}

                <footer class="chat_footer_thread">
                    <form method="POST" action="{% url 'myus:chat_message' %}" id="reply_form" obj-id="{{ object.id }}">{% csrf_token %}
                        {% if is_period %}
                        <textarea name="text" rows="1" class="textarea_br" placeholder="チャット期間が過ぎています！" disabled="disabled"></textarea>
                        <div class="chat_frame chat_frame_color"></div>
                        <div class="comment_input_chat">
                            <button type="submit" class="btn btn-secondary btn-sm" title="送信" disabled>
                                <i class="bi bi-caret-right-fill" style="font-size: 1.2em;"></i>
                            </button>
                        </div>
                        {% elif user.is_authenticated %}
                        <textarea name="text2" rows="1" class="textarea_br" placeholder="スレッド返信" required></textarea>
                        <div class="chat_frame"></div>
                        <div class="comment_input_chat">
                            <button type="submit" class="btn btn-primary btn-sm" title="送信">
                                <i class="bi bi-caret-right-fill" style="font-size: 1.2em;"></i>
                            </button>
                        </div>
                        {% else %}
                        <textarea name="text" rows="1" class="textarea_br" placeholder="チャットするにはログインが必要です！" disabled="disabled"></textarea>
                        <div class="chat_frame chat_frame_color"></div>
                        <div class="comment_input_chat">
                            <button type="submit" class="btn btn-secondary btn-sm" disabled title="送信">
                                <i class="bi bi-caret-right-fill" style="font-size: 1.2em;"></i>
                            </button>
                        </div>
                        {% endif %}
                    </form>
                </footer>
            </div>
        </div>    
    {% else %}
    <h2 class="unpublished">非公開に設定されてます！</h2>
    {% endif %}
    </article>
</main>
{% endblock content %}

{% block extrajs %}
<script src="{% static 'js/ajax_chat.js' %}"></script>
{% endblock extrajs %}
